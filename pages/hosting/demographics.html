<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Demographics Form</title>
    
    <!-- Global Styles -->
    <link rel="stylesheet" href="../../styles/global.css">
    
    <!-- Page-specific Styles -->
    <style>
      /* Enhanced form styling */
      .form-header {
        text-align: center;
        margin-bottom: var(--spacing-2xl);
      }
      
      .form-header h1 {
        color: var(--primary-color);
        margin-bottom: var(--spacing-sm);
      }
      
      .form-group {
        margin-bottom: var(--spacing-lg);
        text-align: left;
      }
      
      .form-group label {
        color: var(--gray-700);
        font-size: 1.1em;
        margin-bottom: var(--spacing-sm);
      }
      
      /* Email section styling */
      .email-section {
        background: var(--light-gray);
        padding: var(--spacing-lg);
        border-radius: var(--radius-md);
        margin-bottom: var(--spacing-lg);
      }
      
      .email-consent {
        margin-top: var(--spacing-md);
        padding-top: var(--spacing-md);
        border-top: 1px solid var(--gray-300);
      }
      
      .email-consent label {
        display: flex;
        align-items: flex-start;
        font-weight: normal;
        font-size: 0.95em;
        cursor: pointer;
      }
      
      .email-consent input[type="checkbox"] {
        margin-right: var(--spacing-sm);
        margin-top: 2px;
        cursor: pointer;
      }
      
      /* Optional badge */
      .optional-badge {
        display: inline-block;
        background: #17a2b8;
        color: var(--white);
        font-size: 0.75em;
        padding: 2px 8px;
        border-radius: var(--radius-sm);
        margin-left: var(--spacing-sm);
        font-weight: normal;
      }
      
      /* Progress indicator */
      .progress-dots {
        display: flex;
        justify-content: center;
        gap: var(--spacing-sm);
        margin-bottom: var(--spacing-2xl);
      }
      
      .progress-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--gray-300);
        transition: all var(--transition-base);
      }
      
      .progress-dot.active {
        background: var(--primary-color);
        transform: scale(1.2);
      }
      
      .progress-dot.completed {
        background: var(--success-color);
      }
      
      /* Select styling enhancement */
      select {
        appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 0.7rem center;
        background-size: 1em;
        padding-right: 2.5rem;
      }
    </style>
  </head>
  <body>
    <div class="page-container">
      <div class="form-container">
        <!-- Progress indicator -->
        <div class="progress-dots">
          <div class="progress-dot completed"></div>
          <div class="progress-dot active"></div>
          <div class="progress-dot"></div>
          <div class="progress-dot"></div>
        </div>

        <!-- Header -->
        <div class="form-header">
          <h1>Demographics Information</h1>
          <p class="text-muted">Help us understand our participants better</p>
        </div>

        <form id="demographics-form">
          <!-- Email Section -->
          <div class="email-section">
            <div class="form-group">
              <label for="email">
                Email Address
                <span class="optional-badge">Optional</span>
              </label>
              <input 
                type="email" 
                id="email" 
                name="email" 
                placeholder="your.email@example.com"
              />
            </div>
            
            <div class="email-consent">
              <label>
                <input type="checkbox" id="consent_for_email_reachout_in_future" />
                I consent to being contacted about future research opportunities
              </label>
            </div>
          </div>

          <!-- Gender -->
          <div class="form-group">
            <label for="gender">Gender</label>
            <select id="gender" name="gender" required>
              <option value="">Please select...</option>
              <option value="male">Male</option>
              <option value="female">Female</option>
              <option value="non-binary">Non-binary</option>
              <option value="other">Other</option>
              <option value="prefer_not_to_say">Prefer not to say</option>
            </select>
          </div>

          <!-- Handedness -->
          <div class="form-group">
            <label for="handedness">Handedness</label>
            <select id="handedness" name="handedness" required>
              <option value="">Please select...</option>
              <option value="right">Right-handed</option>
              <option value="left">Left-handed</option>
              <option value="ambidextrous">Ambidextrous</option>
            </select>
          </div>

          <!-- Education -->
          <div class="form-group">
            <label for="education">Education Level</label>
            <select id="education" name="education" required>
              <option value="">Please select...</option>
              <option value="high_school">High School or Less</option>
              <option value="some_college">Some College</option>
              <option value="bachelor">Bachelor's Degree</option>
              <option value="masters">Master's Degree</option>
              <option value="doctorate">Doctorate</option>
              <option value="other">Other</option>
            </select>
          </div>

          <!-- Buttons -->
          <div class="button-container">
            <button type="button" class="btn-secondary" onclick="navigateToPrevious()">
              Previous
            </button>
            <button type="button" class="btn-primary" id="next-button" onclick="handleFormSubmission()">
              Next
            </button>
          </div>
        </form>

        <!-- Message Container -->
        <div id="message-container"></div>
      </div>
    </div>

    <!-- Import shared utilities -->
    <script src="../../utils/common.js"></script>
    
    <!-- Page-specific Scripts -->
    <script>
      // Initialize when page loads
      window.addEventListener('load', function() {
        console.log('Demographics page loaded');
        initializePage();
      });

      function initializePage() {
        try {
          // Verify we have a user ID from the previous page
          const userId = NavigationManager.getQueryParam('user_id');
          if (!userId) {
            showMessage('Session not found. Redirecting...', 'error');
            setTimeout(() => {
              window.location.href = 'consent.html';
            }, 2000);
            return;
          }

          console.log('User ID verified:', userId);
          
          // Store in cookie for consistency
          SecureCookieManager.setCookie('user_id', userId);
          
        } catch (error) {
          console.error('Failed to initialize demographics page:', error);
          showMessage('Failed to initialize page. Please try again.', 'error');
        }
      }

      async function handleFormSubmission() {
        const nextButton = document.getElementById('next-button');

        try {
          // Clear any existing messages
          clearMessages();

          // Validate form
          const formData = validateAndGetFormData();
          if (!formData) {
            return; // Validation errors already shown
          }

          // Show loading state
          nextButton.disabled = true;
          nextButton.innerHTML = '<span class="spinner"></span> Processing...';
          document.getElementById('demographics-form').classList.add('loading');

          // Get user ID
          const userId = NavigationManager.getQueryParam('user_id') || 
                         SecureCookieManager.getCookie('user_id');
          
          if (!userId) {
            throw new Error('User ID not found');
          }

          // Upload demographics data
          await uploadDemographicsData(formData, userId);

          // Show success briefly
          showMessage('Information saved successfully!', 'success');
          
          // Navigate to next page
          setTimeout(() => {
            NavigationManager.navigateWithUserId('instructions.html', userId);
          }, 500);

        } catch (error) {
          console.error('Form submission failed:', error);
          showMessage('Failed to submit form. Please try again.', 'error');
          
          // Reset button state
          nextButton.disabled = false;
          nextButton.innerHTML = 'Next';
          document.getElementById('demographics-form').classList.remove('loading');
        }
      }

      function validateAndGetFormData() {
        // Get form values
        const email = document.getElementById('email').value.trim();
        const gender = document.getElementById('gender').value;
        const handedness = document.getElementById('handedness').value;
        const education = document.getElementById('education').value;
        const emailConsent = document.getElementById('consent_for_email_reachout_in_future').checked;

        // Validate email if provided
        if (email) {
          const emailValidation = FormValidator.validateEmail(email);
          if (!emailValidation.valid) {
            showMessage(emailValidation.message, 'error');
            document.getElementById('email').focus();
            return null;
          }
        }

        // Validate required fields
        if (!gender) {
          showMessage('Please select your gender', 'error');
          document.getElementById('gender').focus();
          return null;
        }

        if (!handedness) {
          showMessage('Please select your handedness', 'error');
          document.getElementById('handedness').focus();
          return null;
        }

        if (!education) {
          showMessage('Please select your education level', 'error');
          document.getElementById('education').focus();
          return null;
        }

        // Handle email consent validation
        if (email && !emailConsent) {
          const confirmed = confirm(
            "You provided an email but didn't consent to future contact. " +
            "Your email will not be saved. Continue anyway?"
          );
          if (!confirmed) {
            return null;
          }
        }

        return {
          email: emailConsent ? email : '', // Only store email if consent given
          gender,
          handedness,
          education,
          consent_email_for_future: emailConsent,
          submission_timestamp: new Date().toISOString()
        };
      }

      async function uploadDemographicsData(formData, userId) {
        console.log('Uploading demographics data...');

        const jsonBlob = new Blob([JSON.stringify(formData, null, 2)], {
          type: "application/json",
        });

        const fileName = `${userId}_demographics.json`;
        
        const result = await APIClient.uploadFile(jsonBlob, fileName, userId);
        console.log('âœ… Demographics data uploaded:', result.fileName);
        return result;
      }

      function navigateToPrevious() {
        if (confirm('Are you sure you want to go back? Your current progress will be lost.')) {
          window.location.href = 'consent.html';
        }
      }

      function showMessage(message, type) {
        const container = document.getElementById('message-container');
        const messageDiv = document.createElement('div');
        messageDiv.className = `${type}-message mt-2`;
        messageDiv.textContent = message;
        container.appendChild(messageDiv);
        
        // Auto-remove after 5 seconds
        setTimeout(() => messageDiv.remove(), 5000);
      }

      function clearMessages() {
        document.getElementById('message-container').innerHTML = '';
      }

      // Error handling
      window.addEventListener('unhandledrejection', function(event) {
        console.error('Unhandled promise rejection:', event.reason);
        showMessage('An unexpected error occurred. Please try again.', 'error');
      });
    </script>
  </body>
</html>