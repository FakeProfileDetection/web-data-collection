<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Task Spotlight</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        background-color: #f4f4f4;
        text-align: center;
      }
      .task-container {
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        max-width: 650px;
        width: 100%;
        background: white;
        padding: 20px;
      }
      h1,
      h2 {
        color: #333;
      }
      video {
        width: 100%;
        height: auto;
        margin-top: 10px;
        border-radius: 8px;
      }
      .button-container {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
        gap: 10px;
      }
      button {
        flex: 1;
        padding: 12px;
        margin: 5px;
        font-size: 1.1em;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      button:hover:not(:disabled) {
        transform: translateY(-1px);
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }
      .next-button {
        background-color: #28a745;
        color: white;
      }
      .next-button:hover:not(:disabled) {
        background-color: #218838;
      }
      .back-button {
        background-color: #6c757d;
        color: white;
      }
      .back-button:hover:not(:disabled) {
        background-color: #5a6268;
      }
      .complete-button {
        background-color: #007bff;
        color: white;
      }
      .complete-button:hover:not(:disabled) {
        background-color: #0056b3;
      }

      .progress-container {
        width: 100%;
        background-color: #ddd;
        border-radius: 8px;
        margin: 15px 0;
        height: 30px;
        position: relative;
      }
      .progress-bar {
        height: 100%;
        width: 0%;
        background-color: #4caf50;
        transition: width 0.4s ease-in-out;
        border-radius: 8px;
      }
      #task-counter {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        font-size: 14px;
        font-weight: bold;
        color: #333;
      }

      /* Error message styling */
      .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
        border: 1px solid #f5c6cb;
      }

      /* Success message styling */
      .success-message {
        background: #d4edda;
        color: #155724;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
        border: 1px solid #c3e6cb;
      }

      /* Loading state */
      .loading {
        opacity: 0.6;
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <div class="task-container">
      <h1 id="platform-name">Loading...</h1>
      <h2 id="task-name">Initializing tasks...</h2>

      <div class="progress-container">
        <div class="progress-bar" id="progress-bar"></div>
        <span id="task-counter">Loading...</span>
      </div>

      <video controls id="video-frame">
        <source src="" type="video/mp4" />
        Your browser does not support the video tag.
      </video>

      <div class="button-container">
        <button
          class="back-button"
          id="back-task"
          onclick="previousTask()"
          style="display: none"
        >
          ← Back
        </button>
        <button class="next-button" id="next-task" onclick="nextTask()">
          Loading...
        </button>
      </div>
    </div>

    <!-- Import our shared utilities -->
    <script src="../../utils/common.js"></script>
    
    <script>
      // Task definitions using the CONFIG from common.js
      const tasks = [
        // First cycle
        {
          platform: CONFIG.PLATFORMS.FACEBOOK.name,
          task: "Watch Coach Carter Movie Clip",
          video: CONFIG.VIDEOS.CARTER,
          link: CONFIG.PLATFORMS.FACEBOOK.url,
          platformId: CONFIG.PLATFORMS.FACEBOOK.id
        },
        {
          platform: CONFIG.PLATFORMS.INSTAGRAM.name,
          task: "Watch Coach Carter Movie Clip",
          video: CONFIG.VIDEOS.CARTER,
          link: CONFIG.PLATFORMS.INSTAGRAM.url,
          platformId: CONFIG.PLATFORMS.INSTAGRAM.id
        },
        {
          platform: CONFIG.PLATFORMS.TWITTER.name,
          task: "Watch Coach Carter Movie Clip",
          video: CONFIG.VIDEOS.CARTER,
          link: CONFIG.PLATFORMS.TWITTER.url,
          platformId: CONFIG.PLATFORMS.TWITTER.id
        },
        {
          platform: CONFIG.PLATFORMS.FACEBOOK.name,
          task: "Watch The Oscar Slap Clip",
          video: CONFIG.VIDEOS.OSCARS,
          link: CONFIG.PLATFORMS.FACEBOOK.url,
          platformId: CONFIG.PLATFORMS.FACEBOOK.id
        },
        {
          platform: CONFIG.PLATFORMS.INSTAGRAM.name,
          task: "Watch The Oscar Slap Clip",
          video: CONFIG.VIDEOS.OSCARS,
          link: CONFIG.PLATFORMS.INSTAGRAM.url,
          platformId: CONFIG.PLATFORMS.INSTAGRAM.id
        },
        {
          platform: CONFIG.PLATFORMS.TWITTER.name,
          task: "Watch The Oscar Slap Clip",
          video: CONFIG.VIDEOS.OSCARS,
          link: CONFIG.PLATFORMS.TWITTER.url,
          platformId: CONFIG.PLATFORMS.TWITTER.id
        },
        {
          platform: CONFIG.PLATFORMS.FACEBOOK.name,
          task: "Watch Trump/Vance & Zelenskyy Oval Office Meeting",
          video: CONFIG.VIDEOS.TRUMP,
          link: CONFIG.PLATFORMS.FACEBOOK.url,
          platformId: CONFIG.PLATFORMS.FACEBOOK.id
        },
        {
          platform: CONFIG.PLATFORMS.INSTAGRAM.name,
          task: "Watch Trump/Vance & Zelenskyy Oval Office Meeting",
          video: CONFIG.VIDEOS.TRUMP,
          link: CONFIG.PLATFORMS.INSTAGRAM.url,
          platformId: CONFIG.PLATFORMS.INSTAGRAM.id
        },
        {
          platform: CONFIG.PLATFORMS.TWITTER.name,
          task: "Watch Trump/Vance & Zelenskyy Oval Office Meeting",
          video: CONFIG.VIDEOS.TRUMP,
          link: CONFIG.PLATFORMS.TWITTER.url,
          platformId: CONFIG.PLATFORMS.TWITTER.id
        },
        // Second cycle (repeat)
        {
          platform: CONFIG.PLATFORMS.FACEBOOK.name,
          task: "Watch Coach Carter Movie Clip (Round 2)",
          video: CONFIG.VIDEOS.CARTER,
          link: CONFIG.PLATFORMS.FACEBOOK.url,
          platformId: CONFIG.PLATFORMS.FACEBOOK.id
        },
        {
          platform: CONFIG.PLATFORMS.INSTAGRAM.name,
          task: "Watch Coach Carter Movie Clip (Round 2)",
          video: CONFIG.VIDEOS.CARTER,
          link: CONFIG.PLATFORMS.INSTAGRAM.url,
          platformId: CONFIG.PLATFORMS.INSTAGRAM.id
        },
        {
          platform: CONFIG.PLATFORMS.TWITTER.name,
          task: "Watch Coach Carter Movie Clip (Round 2)",
          video: CONFIG.VIDEOS.CARTER,
          link: CONFIG.PLATFORMS.TWITTER.url,
          platformId: CONFIG.PLATFORMS.TWITTER.id
        },
        {
          platform: CONFIG.PLATFORMS.FACEBOOK.name,
          task: "Watch The Oscar Slap Clip (Round 2)",
          video: CONFIG.VIDEOS.OSCARS,
          link: CONFIG.PLATFORMS.FACEBOOK.url,
          platformId: CONFIG.PLATFORMS.FACEBOOK.id
        },
        {
          platform: CONFIG.PLATFORMS.INSTAGRAM.name,
          task: "Watch The Oscar Slap Clip (Round 2)",
          video: CONFIG.VIDEOS.OSCARS,
          link: CONFIG.PLATFORMS.INSTAGRAM.url,
          platformId: CONFIG.PLATFORMS.INSTAGRAM.id
        },
        {
          platform: CONFIG.PLATFORMS.TWITTER.name,
          task: "Watch The Oscar Slap Clip (Round 2)",
          video: CONFIG.VIDEOS.OSCARS,
          link: CONFIG.PLATFORMS.TWITTER.url,
          platformId: CONFIG.PLATFORMS.TWITTER.id
        },
        {
          platform: CONFIG.PLATFORMS.FACEBOOK.name,
          task: "Watch Trump/Vance & Zelenskyy Oval Office Meeting (Round 2)",
          video: CONFIG.VIDEOS.TRUMP,
          link: CONFIG.PLATFORMS.FACEBOOK.url,
          platformId: CONFIG.PLATFORMS.FACEBOOK.id
        },
        {
          platform: CONFIG.PLATFORMS.INSTAGRAM.name,
          task: "Watch Trump/Vance & Zelenskyy Oval Office Meeting (Round 2)",
          video: CONFIG.VIDEOS.TRUMP,
          link: CONFIG.PLATFORMS.INSTAGRAM.url,
          platformId: CONFIG.PLATFORMS.INSTAGRAM.id
        },
        {
          platform: CONFIG.PLATFORMS.TWITTER.name,
          task: "Watch Trump/Vance & Zelenskyy Oval Office Meeting (Round 2)",
          video: CONFIG.VIDEOS.TRUMP,
          link: CONFIG.PLATFORMS.TWITTER.url,
          platformId: CONFIG.PLATFORMS.TWITTER.id
        }
      ];

      // Global state
      let currentTaskIndex = 0;
      let userId = null;

      // Initialize when page loads
      window.addEventListener('load', function() {
        console.log('Tasks page loaded');
        initializePage();
      });

      function initializePage() {
        try {
          // Get user ID from URL or cookie
          userId = NavigationManager.getQueryParam('user_id') || 
                   SecureCookieManager.getCookie('user_id');
          
          if (!userId) {
            FormValidator.showError('Session not found. Please start from the beginning.');
            setTimeout(() => {
              window.location.href = 'consent.html';
            }, 3000);
            return;
          }

          console.log('Tasks initialized for user:', userId);
          
          // Store in cookie for consistency
          SecureCookieManager.setCookie('user_id', userId);
          
          // Load the first task
          loadTask(currentTaskIndex);
          
        } catch (error) {
          console.error('Failed to initialize tasks page:', error);
          FormValidator.showError('Failed to initialize tasks. Please try again.');
        }
      }

      // Update progress bar & counter
      function updateProgressBar() {
        const percent = ((currentTaskIndex + 1) / tasks.length) * 100;
        document.getElementById("progress-bar").style.width = percent + "%";
        document.getElementById("task-counter").textContent = `Task ${
          currentTaskIndex + 1
        } of ${tasks.length}`;
      }

      // Load a given task, toggle Back button visibility
      function loadTask(index) {
        try {
          if (index < 0 || index >= tasks.length) {
            console.error('Invalid task index:', index);
            return;
          }

          const task = tasks[index];
          
          // Update UI elements
          document.getElementById("platform-name").textContent = task.platform;
          document.getElementById("task-name").textContent = `Task ${index + 1}: ${task.task}`;
          
          const videoElement = document.getElementById("video-frame");
          videoElement.src = task.video;
          
          // Update button states
          const backButton = document.getElementById("back-task");
          const nextButton = document.getElementById("next-task");
          
          backButton.style.display = index === 0 ? "none" : "inline-block";
          
          if (index >= tasks.length - 1) {
            nextButton.textContent = "Complete Study";
            nextButton.className = "complete-button";
          } else {
            nextButton.textContent = "Next Task →";
            nextButton.className = "next-button";
          }

          updateProgressBar();
          
          console.log(`Loaded task ${index + 1}: ${task.platform} - ${task.task}`);
          
        } catch (error) {
          console.error('Failed to load task:', error);
          FormValidator.showError('Failed to load task. Please refresh the page.');
        }
      }

      // Next: open platform page in new tab & advance UI
      async function nextTask() {
        const nextButton = document.getElementById("next-task");
        
        try {
          // Check if we're at the end
          if (currentTaskIndex >= tasks.length) {
            window.location.href = "complete.html";
            return;
          }

          const task = tasks[currentTaskIndex];
          
          if (!userId) {
            FormValidator.showError('User session lost. Please start from the beginning.');
            return;
          }

          // Show loading state
          nextButton.disabled = true;
          const originalText = nextButton.textContent;
          nextButton.textContent = "Opening platform...";

          console.log(`Opening platform for task ${currentTaskIndex + 1}:`, task.platform);

          // Open platform window
          const success = NavigationManager.openPlatform(
            task.link, 
            userId, 
            task.platformId, 
            currentTaskIndex
          );

          if (!success) {
            // Error already shown by NavigationManager
            nextButton.disabled = false;
            nextButton.textContent = originalText;
            return;
          }

          // Show success message
          const successDiv = document.createElement('div');
          successDiv.className = 'success-message';
          successDiv.textContent = `${task.platform} opened in new tab. Complete your post there, then return here.`;
          document.querySelector('.task-container').insertBefore(successDiv, document.querySelector('.button-container'));
          
          // Auto-remove success message
          setTimeout(() => successDiv.remove(), 5000);

          // Advance to next task
          currentTaskIndex++;
          
          // Update UI for next task or completion
          if (currentTaskIndex >= tasks.length) {
            nextButton.textContent = "Complete Study";
            nextButton.className = "complete-button";
            nextButton.disabled = false;
          } else {
            loadTask(currentTaskIndex);
            nextButton.disabled = false;
          }

        } catch (error) {
          console.error('Failed to advance task:', error);
          FormValidator.showError('Failed to open platform. Please try again.');
          
          // Reset button state
          nextButton.disabled = false;
          nextButton.textContent = originalText;
        }
      }

      // Back: only update UI, don't open new tab
      function previousTask() {
        try {
          if (currentTaskIndex > 0) {
            currentTaskIndex--;
            loadTask(currentTaskIndex);
            console.log(`Went back to task ${currentTaskIndex + 1}`);
          }
        } catch (error) {
          console.error('Failed to go back:', error);
          FormValidator.showError('Failed to go back. Please try again.');
        }
      }

      // Error handling
      window.addEventListener('unhandledrejection', function(event) {
        console.error('Unhandled promise rejection:', event.reason);
        FormValidator.showError('An unexpected error occurred. Please try again.');
      });

      window.addEventListener('error', function(event) {
        console.error('JavaScript error:', event.error);
        FormValidator.showError('An unexpected error occurred. Please try again.');
      });
    </script>
  </body>
</html>